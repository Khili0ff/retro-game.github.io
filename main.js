(()=>{"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.positionedList=[],this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[],this.acceptableMove=null,this.acceptableAttack=null,this.level=1}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile","map-tile-"+(t=e,a=this.boardSize,t>0&&t<a-1?"top":0===t?"top-left":t===a-1?"top-right":t%a==0&&t!==a**2-a&&0!==t?"left":t%a==a-1&&t!==a**2-1&&t!==a-1?"right":t>a**2-a&&t<a**2-1?"bottom":t===a**2-a?"bottom-left":t===a**2-1?"bottom-right":"center")),s.addEventListener("mouseenter",(e=>this.onCellEnter(e))),s.addEventListener("mouseleave",(e=>this.onCellLeave(e))),s.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(s)}var t,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const l=document.createElement("div");l.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),l.style.width=`${a.character.health}%`,i.appendChild(l),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}showError(e){alert(e)}showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}createMessageCharacter(e){let t=null;return this.positionedList.forEach((a=>{a.position===e&&(t=`🎖${a.character.level} ⚔${a.character.attack} 🛡${a.character.defence} ❤${a.character.health}`)})),t}getCharacterFromList(e){let t=null;return this.positionedList.forEach((a=>{a.position===e&&(t=a.character)})),t}whoseCharecter(e){let t=null;switch(e){case"vampire":case"undead":case"daemon":t="opponent";break;case"bowman":case"swordsman":case"magician":t="player";break;default:throw new Error("undefined type")}return t}checkCharactersAlive(){let e=0,t=0;return this.positionedList.forEach((a=>{const s=this.whoseCharecter(a.character.type);"player"===s&&(e+=1),"opponent"===s&&(t+=1)})),{player:e,opponent:t}}}const t={"Level 1":"prairie","Level 2":"desert","Level 3":"arctic","Level 4":"mountain"};class a{constructor(e){this.characters=e.sort(((e,t)=>t.level-e.level))}}function s(e,t,s){const i=function*(e,t){for(;;){const a=Math.floor(Math.random()*t+1),s=e[Math.floor(Math.random()*e.length)];yield new s(a)}}(e,t),l=[];for(let e=0;e<s;e+=1)l.push(i.next().value);return new a(l)}function i(e,t,a=[]){const s=[];for(let a=e;a<t**2;a+=t-1)s.push(a),s.push(a+=1);return 0!==a.length&&a.forEach((e=>{const t=s.findIndex((t=>e.position===t));-1!==t&&s.splice(t,1)})),s}function l(e,t,a){let s;for(;!s;){const i=Math.floor(Math.random()*t**2+e);a.includes(i)&&(s=i)}return s}class r{constructor(e,t="generic"){if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,new.target===r)throw new Error("it is impossible to create a character in this way")}rangeAction(){switch(this.type){case"swordsman":case"undead":this.moveRadius=4,this.attackRadius=1;break;case"bowman":case"vampire":this.moveRadius=2,this.attackRadius=2;break;case"magician":case"daemon":this.moveRadius=1,this.attackRadius=4;break;default:throw new Error("character type undefined")}}}class n{constructor(e,t){if(!(e instanceof r))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class o{static from(e){const{walked:t}=localStorage;if(void 0!==t){const a=JSON.parse(t);if(a.position!==e.position)return localStorage.walked=JSON.stringify(e),a;if(a.position===e.position)return a.position=e.position,a}return localStorage.walked=JSON.stringify(e),null}static score(e){const t=e,a=(new Date).toLocaleString();return t.date=a,localStorage.score=JSON.stringify(t),null}}class c{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}const h="pointer",d="crosshair",m="not-allowed";class g extends r{constructor(e){super(e,"bowman"),super.rangeAction(),this.attack+=25,this.defence+=25}}class p extends r{constructor(e){super(e,"swordsman"),super.rangeAction(),this.attack+=40,this.defence+=10}}class u extends r{constructor(e){super(e,"magician"),super.rangeAction(),this.attack+=10,this.defence+=40}}class y extends r{constructor(e){super(e,"vampire"),super.rangeAction(),this.attack+=25,this.defence+=25}}class P extends r{constructor(e){super(e,"daemon"),super.rangeAction(),this.attack+=10,this.defence+=10}}class L extends r{constructor(e){super(e,"undead"),super.rangeAction(),this.attack+=40,this.defence+=10}}class f{constructor(e,t){this.gamePlay=e,this.stateService=t}init(){this.gamePlay.drawUi(t[`Level ${this.gamePlay.level}`]),this.gamePlay.redrawPositions(this.redraw()),this.gamePlay.addCellEnterListener((e=>this.onCellEnter.call(this,e))),this.gamePlay.addCellLeaveListener((e=>this.onCellLeave.call(this,e))),this.gamePlay.addCellClickListener((e=>this.onCellClick.call(this,e))),this.gamePlay.addNewGameListener((()=>this.onNewGameClick.call(this))),this.gamePlay.addSaveGameListener((()=>this.onSaveGameClick.call(this))),this.gamePlay.addLoadGameListener((()=>this.onLoadGameClick.call(this)))}redraw(){const e=s([g,p,u],2,2),{boardSize:t,positionedList:a}=this.gamePlay,r=i(0,t,a);e.characters.forEach((e=>{const a=l(0,t,r);this.gamePlay.positionedList.push(new n(e,a)),r.splice(r.indexOf(a),1)}));const o=s([y,P,L],4,4),c=i(6,t);return o.characters.forEach((e=>{const a=l(0,t,c);this.gamePlay.positionedList.push(new n(e,a)),c.splice(c.indexOf(a),1)})),this.gamePlay.positionedList}onNewGameClick(){o.score({level:this.gamePlay.level}),localStorage.clear();const t=new c(localStorage),a=new e;a.bindToDOM(document.querySelector("#game-container")),new f(a,t).init()}onSaveGameClick(){o.score({level:this.gamePlay.level}),this.stateService.save(this.gamePlay)}onLoadGameClick(){const e=this.stateService.load();null!==e?(this.gamePlay.positionedList=e.positionedList,this.gamePlay.level=e.level,this.gamePlay.drawUi(t[`Level ${this.gamePlay.level}`]),this.gamePlay.redrawPositions(this.gamePlay.positionedList)):this.gamePlay.showMessage("there are no saves")}onCellClick(e){const t=this.gamePlay.getCharacterFromList(e);if(null!==t){const a=this.gamePlay.whoseCharecter(t.type);if("player"===a){const a=o.from({character:t,position:e});null!==a&&(this.gamePlay.deselectCell(a.position),this.gamePlay.cellEnterListeners.length=0),this.gamePlay.selectCell(e),this.gamePlay.acceptableMove=this.calcRadius(t.moveRadius,e),this.gamePlay.acceptableAttack=this.calcRadius(t.attackRadius,e),this.acceptableActions(this.gamePlay.acceptableMove,this.gamePlay.acceptableAttack)}if("opponent"===a&&null===this.gamePlay.acceptableAttack)this.gamePlay.showMessage("you cannot select an opponent character");else if(this.gamePlay.acceptableAttack.includes(e)){const a=JSON.parse(localStorage.walked),{attack:s}=a.character,i=Math.max(s-t.defence,.1*s);this.gamePlay.positionedList=this.gamePlay.positionedList.filter((t=>{const a=t;if(a.position===e){if(a.character.health-=i,this.gamePlay.redrawPositions(this.gamePlay.positionedList),!(!a.character.health<=0))return!1;this.computerRunning()}return a})),this.gamePlay.showDamage(e,i).then((()=>{this.gamePlay.deselectCell(e),this.gamePlay.redrawPositions(this.gamePlay.positionedList),0===this.gamePlay.checkCharactersAlive().opponent&&(this.nextLevel(),this.basicSettings(JSON.parse(localStorage.walked).position))}))}}const{acceptableMove:a}=this.gamePlay;if(null===t&&null!==a&&a.includes(e)){const t=JSON.parse(localStorage.walked),{character:a}=t;this.gamePlay.positionedList=this.gamePlay.positionedList.filter((s=>{const i=s;return i.position===Number(t.position)&&(o.from({character:a,position:e}),i.position=e),i})),this.gamePlay.deselectCell(t.position),this.gamePlay.selectCell(e),this.gamePlay.cellEnterListeners.length=0,this.gamePlay.acceptableMove=this.calcRadius(a.moveRadius,e),this.gamePlay.acceptableAttack=this.calcRadius(a.attackRadius,e),this.acceptableActions(this.gamePlay.acceptableMove,this.gamePlay.acceptableAttack),this.gamePlay.redrawPositions(this.gamePlay.positionedList),this.computerRunning()}this.gamePlay.addCellEnterListener((e=>this.onCellEnter.call(this,e)))}computerRunning(){const e=this.gamePlay.positionedList.filter((e=>"opponent"===this.gamePlay.whoseCharecter(e.character.type))),t=this.gamePlay.positionedList.filter((e=>"player"===this.gamePlay.whoseCharecter(e.character.type)));let a=!1;if(e.forEach((e=>{if(!a){const{character:s,character:{attack:i}}=e,l=this.calcRadius(s.attackRadius,e.position);for(let e=0;e<t.length;e+=1)if(l.includes(t[e].position)){const s=Math.max(i-t[e].character.defence,.1*i),l=this.gamePlay.positionedList.filter((a=>{const i=a;return i.position===t[e].position&&(i.character.health-=s),i.character.health<=0?(JSON.parse(localStorage.walked).position===i.position&&this.basicSettings(i.position),!1):i}));this.gamePlay.showDamage(t[e].position,s).then((()=>{this.gamePlay.positionedList=l,this.gamePlay.redrawPositions(this.gamePlay.positionedList),0===this.gamePlay.checkCharactersAlive().player&&(this.gamePlay.showMessage("Game Over!"),this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[],this.gamePlay.addCellLeaveListener=[])})),a=!0;break}}})),!a){const t=e[Math.floor(Math.random()*e.length)],a=this.calcRadius(t.character.moveRadius,t.position).filter((e=>null===this.gamePlay.getCharacterFromList(e)&&e)),s=Math.floor(Math.random()*a.length);this.gamePlay.positionedList=this.gamePlay.positionedList.filter((e=>(e.position===t.position&&(e.position=a[s]),e))),this.gamePlay.redrawPositions(this.gamePlay.positionedList)}}onCellEnter(e){const t=this.gamePlay.createMessageCharacter(e);null!==t&&this.gamePlay.showCellTooltip(t,e)}onCellLeave(e){this.gamePlay.hideCellTooltip(e)}acceptableActions(e,t){this.gamePlay.addCellEnterListener((a=>{const s=this.gamePlay.getCharacterFromList(a);if(null===s&&e.includes(a)&&(this.gamePlay.setCursor(h),this.gamePlay.selectCell(a,"green")),null!==s||e.includes(a)||this.gamePlay.setCursor(m),null!==s){const e=this.gamePlay.whoseCharecter(s.type);"opponent"===e&&(t.includes(a)?(this.gamePlay.setCursor(d),this.gamePlay.selectCell(a,"red")):this.gamePlay.setCursor(m)),"player"===e&&this.gamePlay.setCursor(h)}})),this.gamePlay.addCellLeaveListener((e=>{const t=this.gamePlay.getCharacterFromList(e);null===t&&this.gamePlay.deselectCell(e),null!==t&&"opponent"===this.gamePlay.whoseCharecter(t.type)&&this.gamePlay.deselectCell(e)}))}calcRadius(e,t){const a=[];let s=this.gamePlay.boardSize,i=this.gamePlay.cells[t];for(let i=1;i<=e;i+=1)t>=s&&(a.push(t-s),s+=this.gamePlay.boardSize);s=this.gamePlay.boardSize;for(let i=1;i<=e;i+=1)t+s<this.gamePlay.boardSize**2&&(a.push(t+s),s+=this.gamePlay.boardSize);s=this.gamePlay.boardSize;for(let s=1;s<=e;s+=1)0===Array.from(i.classList).filter((e=>e.split("-").includes("right"))).length&&(a.push(t+s),i=this.gamePlay.cells[t+s]);i=this.gamePlay.cells[t];for(let s=1;s<=e;s+=1)0===Array.from(i.classList).filter((e=>e.split("-").includes("left"))).length&&(a.push(t-s),i=this.gamePlay.cells[t-s]);i=this.gamePlay.cells[t];for(let l=1;l<=e;l+=1){const e=Array.from(i.classList);t>=s&&0===e.filter((e=>e.split("-").includes("right"))).length&&(a.push(t-(s-l)),i=this.gamePlay.cells[t-(s-l)],s+=this.gamePlay.boardSize)}i=this.gamePlay.cells[t],s=this.gamePlay.boardSize;for(let l=1;l<=e;l+=1){const e=Array.from(i.classList);t>=s&&0===e.filter((e=>e.split("-").includes("left"))).length&&(a.push(t-(s+l)),i=this.gamePlay.cells[t-(s+l)],s+=this.gamePlay.boardSize)}i=this.gamePlay.cells[t],s=this.gamePlay.boardSize;for(let l=1;l<=e;l+=1){const e=Array.from(i.classList);t+s<this.gamePlay.boardSize**2&&0===e.filter((e=>e.split("-").includes("right"))).length&&(a.push(t+(s+l)),i=this.gamePlay.cells[t+(s+l)],s+=this.gamePlay.boardSize)}i=this.gamePlay.cells[t],s=this.gamePlay.boardSize;for(let l=1;l<=e;l+=1){const e=Array.from(i.classList);t+s<this.gamePlay.boardSize**2&&0===e.filter((e=>e.split("-").includes("left"))).length&&(a.push(t+(s-l)),i=this.gamePlay.cells[t+(s-l)],s+=this.gamePlay.boardSize)}return i=this.gamePlay.cells[t],s=this.gamePlay.boardSize,a}basicSettings(e){this.gamePlay.acceptableMove=null,this.gamePlay.acceptableAttack=null,this.gamePlay.cellEnterListeners.length=0,this.gamePlay.setCursor(h),this.gamePlay.deselectCell(e)}nextLevel(){return 4===this.gamePlay.level?(this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[],this.gamePlay.addCellLeaveListener=[],this.gamePlay.showMessage("Game Win!")):(this.gamePlay.level+=1,this.gamePlay.positionedList=this.gamePlay.positionedList.filter((e=>{const t=i(0,8,this.gamePlay.positionedList);return e.position=l(0,8,t),this.parametersUp(e),e})),this.init(),null)}parametersUp(e){const{level:t,health:a,attack:s,defence:i}=e.character;e.character.level=t+1,e.character.health=a+80>=100?100:a+80,e.character.attack=Math.max(s,s*(80+a)/100),e.character.defence=Math.max(i,i*(80+a)/100)}}const v=new e;v.bindToDOM(document.querySelector("#game-container"));const C=new c(localStorage);new f(v,C).init()})();